{% extends 'core/base.html' %}
{% block content %}

<div class="container" id="order-container" data-order-id="{{ order.id }}" style="max-width:600px; margin:50px auto;">
    <h2 class="order-title">Order Details</h2>

    <!-- Product Card -->
    <div class="product-card">
        <div class="product-flex">
            <div class="product-image">
                {% if order.product.image %}
                    <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}">
                {% endif %}
            </div>
            <div class="product-info">
                <h3>{{ order.product.name }}</h3>
                {% if order.color %}
                <p>
                    Color:
                    <span class="color-circle" style="background:{{ order.color }}"></span>
                </p>
                {% endif %}
                <p>Quantity: {{ order.quantity }}</p>
                <p class="pay-amount">â‚¹{{ order.total_price|floatformat:2 }}</p>
            </div>
        </div>

        <!-- Return Order Section -->
        {% if order.delivered_date and not order.return_requested %}
        <button type="button" class="return-btn" id="show-return-form-btn">
            Return Order
        </button>

        <div id="return-form-container" style="display:none; margin-top:10px;">
          <form id="return-form" method="POST" action="{% url 'return_request' order.id %}">
            {% csrf_token %}
            <p><strong>Select Reason:</strong></p>
            {% for reason in reasons %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="reason{{ forloop.counter }}" value="{{ reason }}">
                <label class="form-check-label" for="reason{{ forloop.counter }}">{{ reason }}</label>
              </div>
            {% endfor %}

            <div class="mt-2">
              <label for="comment"><strong>Comment (optional):</strong></label>
              <textarea name="comment" class="form-control" rows="2"></textarea>
            </div>

            <button type="submit" class="btn btn-primary mt-2">Send Request</button>
          </form>

          <div id="return-message" style="margin-top:10px; color:green; font-weight:600;"></div>
        </div>

        {% elif order.return_requested %}
        <p class="return-status">
            {% if order.return_status == 'pending' %}Return Requested (Pending Admin Approval){% endif %}
            {% if order.return_status == 'accepted' %}Return Approved{% endif %}
            {% if order.return_status == 'rejected' %}Return Rejected{% endif %}
        </p>

        {% if order.return_status == 'accepted' %}
            <p><strong>Expected Return Date:</strong> {{ order.return_expected_date|date:"d M Y" }}</p>
        {% elif order.return_status == 'rejected' %}
            <p><strong>Rejected Reason:</strong> {{ order.reject_reason }}</p>
        {% endif %}
        {% endif %}
    </div>

    <!-- Timeline -->
    <div class="timeline-modern">
        <div class="timeline-item">
            <div class="timeline-circle {% if order.order_confirmed %}completed{% endif %}" id="circle-confirmed"></div>
            <div class="timeline-content">
                <p class="status-title">Order Confirmed</p>
                <p class="status-date" id="date-confirmed">
                    {% if order.order_confirmed %}{{ order.ordered_at|date:"d M Y H:i" }}{% else %}Pending{% endif %}
                </p>
            </div>
            <div class="timeline-line {% if not order.shipped %}pending{% else %}completed-line{% endif %}"></div>
        </div>

        <div class="timeline-item">
            <div class="timeline-circle {% if order.shipped %}completed{% endif %}" id="circle-shipped"></div>
            <div class="timeline-content">
                <p class="status-title">Shipped</p>
                <p class="status-date" id="date-shipped">
                    {% if order.shipped %}{{ order.shipped_at|date:"d M Y H:i" }}{% else %}Pending{% endif %}
                </p>
            </div>
            <div class="timeline-line {% if not order.out_for_delivery %}pending{% else %}completed-line{% endif %}"></div>
        </div>

        <div class="timeline-item">
            <div class="timeline-circle {% if order.out_for_delivery %}completed{% endif %}" id="circle-out"></div>
            <div class="timeline-content">
                <p class="status-title">Out for Delivery</p>
                <p class="status-date" id="date-out">
                    {% if order.out_for_delivery %}{{ order.out_for_delivery_at|date:"d M Y H:i" }}{% else %}Pending{% endif %}
                </p>
            </div>
            <div class="timeline-line {% if not order.delivered_date %}pending{% else %}completed-line{% endif %}"></div>
        </div>

        <div class="timeline-item">
            <div class="timeline-circle {% if order.delivered_date %}completed{% endif %}" id="circle-delivered"></div>
            <div class="timeline-content">
                <p class="status-title">Delivered</p>
                <p class="status-date" id="date-delivered">
                    {% if order.delivered_date %}{{ order.delivered_date|date:"d M Y" }}{% else %}Pending{% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
.order-title { font-size: 26px; font-weight: 700; color: #1e3a8a; text-align: center; margin-bottom: 40px; }
.product-card { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 50px; transition: transform 0.3s; }
.product-card:hover { transform: translateY(-5px); }
.product-flex { display: flex; gap: 20px; align-items: center; }
.product-image img { width: 100%; border-radius: 15px; object-fit: cover; }
.product-info h3 { font-size: 22px; font-weight: 600; margin-bottom: 10px; }
.product-info p { margin: 6px 0; color: #4b5563; }
.color-circle { display: inline-block; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #d1d5db; }
.pay-amount { margin-top: 12px; font-weight: 700; color: #16a34a; }
.return-btn { display: inline-block; margin-top: 20px; background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
.return-btn:hover { background: #b91c1c; }
.return-status { margin-top: 15px; color: #2563eb; font-weight: 600; }
.timeline-modern { position: relative; display: flex; flex-direction: column; padding-left: 40px; border-left: 2px solid #e5e7eb; }
.timeline-item { position: relative; display: flex; gap: 20px; margin-bottom: 50px; }
.timeline-circle { width: 24px; height: 24px; border-radius: 50%; background: #fff; border: 3px solid #ccc; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.timeline-circle.completed { background: linear-gradient(135deg,#1d4ed8,#3b82f6); border-color: #1d4ed8; }
.timeline-content { flex: 1; }
.status-title { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
.status-date { font-size: 14px; color: #6b7280; }
.timeline-line { position: absolute; width: 4px; left: 11px; top: 28px; bottom: -50px; border-radius: 2px; z-index: 0; }
.timeline-line.completed-line { background: linear-gradient(to bottom, #1d4ed8, #3b82f6); }
.timeline-line.pending { background: #d1d5db; }
.timeline-item:hover .timeline-circle { transform: scale(1.2); border-color: #1d4ed8; }
@media(max-width:600px){ .product-flex { flex-direction: column; } .timeline-modern { padding-left: 30px; } }
</style>

<!-- Rate Your Experience -->
<form id="rating-form" method="POST" action="{% url 'save_order_rating' order.id %}">
    {% csrf_token %}
    <div class="rate-experience" style="margin-top:50px; text-align:center;">
        <h2 style="font-size:24px; font-weight:700; color:#1e3a8a; margin-bottom:15px;">Rate Your Experience</h2>
        <p style="font-weight:600; margin-bottom:10px;">Rate the product</p>
        <div class="stars" id="star-rating">
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="2">&#9733;</span>
            <span class="star" data-value="3">&#9733;</span>
            <span class="star" data-value="4">&#9733;</span>
            <span class="star" data-value="5">&#9733;</span>
        </div>
        <input type="hidden" id="rating-value" name="rating" value="0">
        <button type="submit" class="btn btn-primary mt-2">Submit Rating</button>
    </div>
</form>

<!-- CSS -->
<style>
.stars { display: inline-block; cursor: pointer; }
.stars .star { font-size: 30px; color: #ccc; margin: 0 5px; transition: color 0.2s; }
.stars .star.selected, .stars .star:hover, .stars .star.hovered { color: #1d4ed8; } /* blue color for selected */
</style>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    const stars = document.querySelectorAll('#star-rating .star');
    let selectedRating = 0;

    stars.forEach(star => {
        star.addEventListener('mouseenter', function(){
            const val = parseInt(this.dataset.value);
            highlightStars(val);
        });
        star.addEventListener('mouseleave', function(){
            highlightStars(selectedRating);
        });
        star.addEventListener('click', function(){
            selectedRating = parseInt(this.dataset.value);
            document.getElementById('rating-value').value = selectedRating;
            highlightStars(selectedRating);
        });
    });

    function highlightStars(rating){
        stars.forEach(star => {
            if(parseInt(star.dataset.value) <= rating){
                star.classList.add('selected');
            } else {
                star.classList.remove('selected');
            }
        });
    }
});
</script>



<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
// Show/hide form
document.getElementById("show-return-form-btn")?.addEventListener("click", function(){
    const formContainer = document.getElementById("return-form-container");
    formContainer.style.display = formContainer.style.display === "none" ? "block" : "none";
});

// AJAX Return Form
const returnForm = document.getElementById("return-form");
if(returnForm){
    returnForm.addEventListener("submit", function(e){
        e.preventDefault();

        const formData = new FormData(returnForm);

        fetch(returnForm.action, {
            method: "POST",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            const msgDiv = document.getElementById("return-message");
            if(data.success){
                msgDiv.innerHTML = `<p class="return-status">${data.message}</p>`;

                // hide form
                returnForm.style.display = "none";

                // show details
                const details = document.createElement('div');
                details.innerHTML = `
                    <p><strong>Reason:</strong> ${data.reason}</p>
                    <p><strong>Comment:</strong> ${data.comment}</p>
                    <p><strong>Status:</strong> ${data.return_status}</p>
                    ${data.return_status === 'accepted' ? `<p><strong>Expected Return Date:</strong> ${data.return_expected_date}</p>` : ''}
                    ${data.return_status === 'rejected' ? `<p><strong>Rejected Reason:</strong> ${data.reject_reason}</p>` : ''}
                `;
                msgDiv.appendChild(details);

            } else {
                msgDiv.style.color = "red";
                msgDiv.textContent = data.message;
            }
        })
        .catch(err => console.error(err));
    });
}
</script>

{% endblock %}
