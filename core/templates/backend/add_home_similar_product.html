{% extends 'backend/admin_base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-primary">Add / Edit Similar Product</h2>

    <form method="POST" enctype="multipart/form-data" class="p-4 border rounded shadow-sm bg-light">
        {% csrf_token %}

        <!-- Row 1: Category, Brand, Product Name, Price -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="product" class="form-label fw-semibold">Select Category</label>
                <select name="product" id="product-dropdown" class="form-select" required>
                    <option value="">--Select Category--</option>
                    {% for prod in product_names %}
                        <option value="{{ prod.id }}">{{ prod.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="brand" class="form-label fw-semibold">Select Brand</label>
                <select name="brand" id="brand-dropdown" class="form-select" required>
                    <option value="">--Select Brand--</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Product Name</label>
                <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Price</label>
                <input type="number" name="price" class="form-control" step="0.01" required>
            </div>
        </div>

        <!-- Row 2: Discount, Total Price, Quantity, Product Image -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Discount (%)</label>
                <input type="number" name="discount" class="form-control" step="0.01" value="0">
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Total Price</label>
                <input type="number" name="total_price" class="form-control" step="0.01" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Quantity</label>
                <input type="number" name="quantity" class="form-control" value="1" min="0" required>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Product Image</label>
                <input type="file" name="image" class="form-control">
            </div>
        </div>

        <!-- Colors Section -->
<div class="mb-4">
    <label class="form-label fw-semibold">Select Colors</label>
    <div class="row g-2">
        {% for color, hex in colors %}
        <div class="col-auto">
            <div class="form-check d-flex align-items-center" style="gap:5px;">
                <input class="form-check-input" type="checkbox" name="colors" value="{{ color }}" id="color-{{ forloop.counter }}">
                <label class="form-check-label d-flex align-items-center" for="color-{{ forloop.counter }}">
                    <span style="display:inline-block;width:20px;height:20px;background-color:{{ hex }};border:1px solid #ccc;margin-right:5px;"></span>
                    {{ color }}
                </label>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


        <!-- Product Details Section -->
        <div class="mb-4">
            <label class="form-label fw-semibold">Product Details</label>
            <div id="details-container">
                <div class="row mb-2 g-2">
                    <div class="col-md-5">
                        <input type="text" name="details_name[]" class="form-control" placeholder="Detail Name">
                    </div>
                    <div class="col-md-5">
                        <input type="text" name="details_value[]" class="form-control" placeholder="Detail Value">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="button" class="btn btn-danger remove-detail">Remove</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-2" id="add-more-details">Add More Details</button>
        </div>

        <button type="submit" class="btn btn-success w-100">Save Product</button>
    </form>

    <!-- Saved Products Table -->
    <h3 class="mt-5 mb-3 text-secondary">Saved Products</h3>
    {% if products %}
    <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Category</th>
                <th>Brand</th>
                <th>Price</th>
                <th>Discount</th>
                <th>Quantity</th>
                <th>Colors</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.product.name }}</td>
                <td>{{ product.brand.name }}</td>
                <td>{{ product.price }}</td>
                <td>{{ product.discount }}</td>
                <td>{{ product.quantity }}</td>
                <td>
                    {% for c in product.color_list %}
                        <span class="badge bg-secondary me-1 mb-1">{{ c }}</span>
                    {% endfor %}
                </td>
                <td>
                    <a href="{% url 'edit_home_similar_product' product.id %}" class="btn btn-sm btn-primary me-1">Edit</a>
                    <a href="{% url 'delete_home_similar_product' product.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this product?');">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
        <p class="mt-3">No products added yet.</p>
    {% endif %}
</div>

<script>
    // Brand dropdown
    const productDropdown = document.getElementById('product-dropdown');
    const brandDropdown = document.getElementById('brand-dropdown');

    productDropdown.addEventListener('change', function() {
        const productId = this.value;
        brandDropdown.innerHTML = '<option value="">--Select Brand--</option>';
        if (!productId) return;

        fetch("{% url 'get_brands_by_product' %}?product_id=" + productId)
            .then(response => response.json())
            .then(data => {
                data.brands.forEach(brand => {
                    const opt = document.createElement('option');
                    opt.value = brand.id;
                    opt.textContent = brand.name;
                    brandDropdown.appendChild(opt);
                });
            })
            .catch(err => console.error('Error fetching brands:', err));
    });

    // Total Price calculation
    const priceInput = document.querySelector('input[name="price"]');
    const discountInput = document.querySelector('input[name="discount"]');
    const totalPriceInput = document.querySelector('input[name="total_price"]');

    function updateTotal() {
        const price = parseFloat(priceInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        totalPriceInput.value = (price - (price * discount / 100)).toFixed(2);
    }

    priceInput.addEventListener('input', updateTotal);
    discountInput.addEventListener('input', updateTotal);

    // Dynamic product details
    const addBtn = document.getElementById('add-more-details');
    const container = document.getElementById('details-container');

    addBtn.addEventListener('click', () => {
        const row = document.createElement('div');
        row.classList.add('row', 'mb-2', 'g-2');
        row.innerHTML = `
            <div class="col-md-5">
                <input type="text" name="details_name[]" class="form-control" placeholder="Detail Name">
            </div>
            <div class="col-md-5">
                <input type="text" name="details_value[]" class="form-control" placeholder="Detail Value">
            </div>
            <div class="col-md-2 d-grid">
                <button type="button" class="btn btn-danger remove-detail">Remove</button>
            </div>
        `;
        container.appendChild(row);
    });

    container.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-detail')) {
            e.target.closest('.row').remove();
        }
    });
</script>
{% endblock %}
