{% extends 'backend/admin_base.html' %}
{% block content %}

<h2 class="mb-4">All Orders</h2>

<!-- Filter Form -->
<form method="GET" class="row mb-4">
    <div class="col-md-3">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col-md-3">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col-md-3">
        <label for="status" class="form-label">Order Status</label>
        <select name="status" id="status" class="form-select">
            <option value="">All</option>
            <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>Pending</option>
            <option value="confirmed" {% if request.GET.status == "confirmed" %}selected{% endif %}>Order Confirmed</option>
            <option value="shipped" {% if request.GET.status == "shipped" %}selected{% endif %}>Shipped</option>
            <option value="out_for_delivery" {% if request.GET.status == "out_for_delivery" %}selected{% endif %}>Out for Delivery</option>
            <option value="delivered" {% if request.GET.status == "delivered" %}selected{% endif %}>Delivered</option>
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">Filter</button>
        <a href="{% url 'view_orders' %}" class="btn btn-secondary">Reset</a>
    </div>
</form>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>User</th>
            <th>Customer Name</th>
            <th>Number</th>
            <th>Product</th>
            <th>Image</th>
            <th>Quantity</th>
            <th>Total Price</th>
            <th>Payment Method</th>
            <th>Ordered At</th>
            <th>Shipping Address</th>
            <th>Color</th>
            <th>Status</th>
            <th>Return Request</th>


            
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ order.user.email }}</td>
            <td>{{ order.shipping_address.name }}</td>
            <td>{{ order.shipping_address.mobile }}</td>
            <td>{{ order.product.name }}</td>
            <td>
                {% if order.product.image %}
                <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;">
                {% else %}N/A{% endif %}
            </td>
            <td>{{ order.quantity }}</td>
            <td>â‚¹{{ order.total_price|floatformat:2 }}</td>
            <td>{{ order.get_payment_method_display }}</td>
            <td>{{ order.ordered_at|date:"d M Y H:i" }}</td>
            <td>
                {{ order.shipping_address.address }}, {{ order.shipping_address.city }}, {{ order.shipping_address.state }} - {{ order.shipping_address.pincode }}
            </td>
            <td>
                {% if order.color %}
                <div style="width:20px; height:20px; border-radius:50%; background-color:{{ order.color }}; border:1px solid #ccc;"></div>
                {% else %}N/A{% endif %}
            </td>
            <td>
                <!-- Status Button + Modal (unchanged) -->
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#statusModal{{ order.id }}">
                    Update Status
                </button>


                <div class="modal fade" id="statusModal{{ order.id }}" tabindex="-1" aria-labelledby="statusModalLabel{{ order.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form method="POST" action="{% url 'update_order_status' order.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="statusModalLabel{{ order.id }}">Update Order Status</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="order_confirmed" id="orderConfirmed{{ order.id }}" {% if order.order_confirmed %}checked{% endif %}>
                                <label class="form-check-label" for="orderConfirmed{{ order.id }}">Order Confirmed</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="shipped" id="shipped{{ order.id }}" {% if order.shipped %}checked{% endif %}>
                                <label class="form-check-label" for="shipped{{ order.id }}">Shipped</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="out_for_delivery" id="outForDelivery{{ order.id }}" {% if order.out_for_delivery %}checked{% endif %}>
                                <label class="form-check-label" for="outForDelivery{{ order.id }}">Out for Delivery</label>
                            </div>
                            <div class="mb-2">
                                <label for="delivered_date{{ order.id }}" class="form-label">Delivered Date</label>
                                <input type="date" class="form-control" id="delivered_date{{ order.id }}" name="delivered_date" value="{{ order.delivered_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          <button type="submit" class="btn btn-success">Save changes</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
            </td>



            <td>
    {% if order.return_requested %}
        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#returnModal{{ order.id }}">
            View
        </button>

        <!-- Return Modal -->
        <div class="modal fade" id="returnModal{{ order.id }}" tabindex="-1" aria-labelledby="returnModalLabel{{ order.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="{% url 'process_return' order.id %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title">Process Return Request</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>User Reason:</strong> {{ order.return_reason }}</p>
                    <p><strong>User Comment:</strong> {{ order.return_comment }}</p>

                    <label class="form-label">Action</label>
                    <select name="return_status" class="form-select mb-2 return-action" data-order-id="{{ order.id }}" required>
                        <option value="">--Select Action--</option>
                        <option value="accepted" {% if order.return_status == "accepted" %}selected{% endif %}>Accept</option>
                        <option value="rejected" {% if order.return_status == "rejected" %}selected{% endif %}>Reject</option>
                    </select>

                    <div class="mb-2 return-date-container" id="return-date-container-{{ order.id }}" style="display: {% if order.return_status == 'accepted' %}block{% else %}none{% endif %};">
                        <label class="form-label">Return Expected Date</label>
                        <input type="date" class="form-control" name="return_expected_date" value="{{ order.return_expected_date|date:'Y-m-d' }}">
                    </div>

                    <div class="mb-2 reject-reason-container" id="reject-reason-container-{{ order.id }}" style="display: {% if order.return_status == 'rejected' %}block{% else %}none{% endif %};">
                        <label class="form-label">Reason for Rejection</label>
                        <textarea name="reject_reason" class="form-control" rows="2">{{ order.reject_reason }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-success">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
    {% else %}
        N/A
    {% endif %}
</td>


        </tr>
        {% empty %}
        <tr>
            <td colspan="13" class="text-center">No orders yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>


<!-- JS: handle show/hide of date & reason based on action -->
<script>
document.querySelectorAll('.return-action').forEach(function(select){
    select.addEventListener('change', function(){
        const orderId = this.getAttribute('data-order-id');
        const value = this.value;
        const dateContainer = document.getElementById('return-date-container-' + orderId);
        const rejectContainer = document.getElementById('reject-reason-container-' + orderId);

        if(value === 'accepted'){
            dateContainer.style.display = 'block';
            rejectContainer.style.display = 'none';
        } else if(value === 'rejected'){
            dateContainer.style.display = 'none';
            rejectContainer.style.display = 'block';
        } else {
            dateContainer.style.display = 'none';
            rejectContainer.style.display = 'none';
        }
    });
});
</script>


{% endblock %}
